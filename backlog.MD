# Especificaciones Testeables â€” PulseDesk MVP

> **Documento derivado de la constituciÃ³n del proyecto**  
> **VersiÃ³n:** 1.0.0 | **Fecha:** 2025-10-03

## ğŸ“‹ Resumen

Este documento traduce los principios constitucionales en **especificaciones concretas y testeables** para el desarrollo del MVP de PulseDesk. Cada especificaciÃ³n incluye criterios de aceptaciÃ³n claros y estrategias de testing.

---

## 1. ğŸ’¬ Contexto Persistente (MVP)

### DescripciÃ³n
El bot debe mantener un historial de conversaciÃ³n para usuarios individuales y grupos, permitiendo responder con contexto apropiado.

### Criterios de AceptaciÃ³n
- âœ… **Contexto por usuario**: Mantener historial individual en DMs
- âœ… **Contexto grupal**: Preservar contexto en canales/hilos
- âœ… **Caducidad configurable**: TTL del contexto por configuraciÃ³n
- âœ… **IsolaciÃ³n**: Contextos separados entre usuarios/grupos

### Estrategia de Testing
```typescript
// Ejemplo de test unitario
describe('ContextManager', () => {
  it('should maintain separate context for different users', () => {
    // Test implementation
  });
  
  it('should expire context after configured TTL', () => {
    // Test implementation  
  });
});
```

### Checklist TÃ©cnico
- [ ] Implementar `ContextRepository` en `core/ports/`
- [ ] Crear adapter de persistencia en `infra/persistence/`
- [ ] Tests unitarios para escenarios multiusuario
- [ ] Tests de caducidad temporal

---

## 2. âš¡ Capabilities y Acciones

### DescripciÃ³n
El bot debe ejecutar acciones especÃ­ficas mediante capacidades predefinidas, siguiendo el patrÃ³n hexagonal.

### Capabilities Requeridas
- ğŸ« **Tickets**: Crear/actualizar en Jira/Linear
- ğŸ” **Knowledge Base**: BÃºsquedas RAG/KB
- ğŸ“§ **Notificaciones**: Slack/Email

### Arquitectura Hexagonal
```
core/ports/
â”œâ”€â”€ TicketRepository.ts      # GestiÃ³n de tickets
â”œâ”€â”€ KnowledgeSearch.ts       # BÃºsqueda KB/RAG  
â”œâ”€â”€ Notifier.ts             # Notificaciones
â”œâ”€â”€ AgentClient.ts          # ComunicaciÃ³n Mastra
â””â”€â”€ Scheduler.ts            # Tareas programadas

adapters/
â”œâ”€â”€ slack/                  # SlackBolt adapter
â”œâ”€â”€ mastra/                 # MastraHTTP adapter
â””â”€â”€ integrations/
    â”œâ”€â”€ jira/              # Jira adapter
    â”œâ”€â”€ linear/            # Linear adapter
    â””â”€â”€ email/             # Email adapter
```

### Checklist TÃ©cnico
- [ ] **Interfaces definidas** en `core/ports/`
  - [ ] `TicketRepository.ts`
  - [ ] `KnowledgeSearch.ts` 
  - [ ] `Notifier.ts`
  - [ ] `AgentClient.ts`
  - [ ] `Scheduler.ts`
- [ ] **Adapters implementados**
  - [ ] SlackBolt para comunicaciÃ³n Slack
  - [ ] MastraHTTP para agentes Mastra
  - [ ] IntegraciÃ³n Jira/Linear bÃ¡sica
  - [ ] Sistema de email
- [ ] **Testing**
  - [ ] Tests unitarios con mocks para cada port
  - [ ] Tests de integraciÃ³n para adapters
  - [ ] Contract tests para APIs externas

---

## 3. ğŸ”” Proactividad

### DescripciÃ³n
Implementar lÃ³gica para que el bot envÃ­e recordatorios y avisos automÃ¡ticamente basados en triggers temporales y eventos.

### Tipos de Proactividad
- â° **Timers**: SLA de 48h para tickets
- ğŸ”— **Webhooks**: Cambios de estado en sistemas externos
- ğŸ“… **Scheduled**: Recordatorios programados

### Arquitectura
```typescript
// core/use-cases/ProactiveNotifier.ts
interface ProactiveNotifier {
  scheduleReminder(ticket: Ticket, deadline: Date): Promise<void>;
  handleWebhookEvent(event: WebhookEvent): Promise<void>;
}

// infra/jobs/Scheduler.ts
interface SchedulerAdapter {
  schedule(task: ScheduledTask): Promise<void>;
  cancel(taskId: string): Promise<void>;
}
```

### Checklist TÃ©cnico
- [ ] **Core Logic**
  - [ ] `Scheduler` interface en `core/ports/`
  - [ ] `ProactiveNotifier` use case en `core/use-cases/`
  - [ ] LÃ³gica de SLA y triggers en dominio
- [ ] **Infrastructure**
  - [ ] Adapter de jobs en `infra/jobs/`
  - [ ] Handler de webhooks en `adapters/`
- [ ] **Testing**
  - [ ] Tests unitarios para use cases
  - [ ] Tests de timing y scheduling
  - [ ] Integration tests con mocks temporales

---

## 4. ğŸ—ï¸ Arquitectura Hexagonal (Clean Architecture)

### DescripciÃ³n
Seguir arquitectura hexagonal estricta como base del diseÃ±o del sistema, garantizando testabilidad y mantenibilidad.

### Principios ArquitectÃ³nicos
- ğŸ¯ **Core puro**: Sin dependencias externas
- ğŸ”Œ **Ports & Adapters**: Interfaces claras
- ğŸ“¦ **Dependency Inversion**: Core no depende de detalles

### Estructura Obligatoria
```
src/
â”œâ”€â”€ core/                    # âŒ NO external dependencies
â”‚   â”œâ”€â”€ entities/           # Domain entities
â”‚   â”œâ”€â”€ value-objects/      # Value objects  
â”‚   â”œâ”€â”€ use-cases/         # Business logic
â”‚   â”œâ”€â”€ ports/             # Interfaces (REQUIRED)
â”‚   â””â”€â”€ errors/            # Domain errors
â”œâ”€â”€ adapters/              # âœ… External integrations
â”‚   â”œâ”€â”€ slack/
â”‚   â”œâ”€â”€ mastra/
â”‚   â””â”€â”€ integrations/
â””â”€â”€ infra/                 # âœ… Infrastructure
    â”œâ”€â”€ config/
    â”œâ”€â”€ logging/
    â””â”€â”€ persistence/
```

### Checklist TÃ©cnico
- [ ] **Boundary Enforcement**
  - [ ] `core/` sin imports de `adapters/` o `infra/`
  - [ ] ESLint rules para dependency boundaries
  - [ ] Tests que validen isolaciÃ³n
- [ ] **Interfaces Completas**
  - [ ] Todos los ports definidos en `core/ports/`
  - [ ] Adapters implementan interfaces
  - [ ] Dependency injection en bootstrap
- [ ] **Testing Architecture**
  - [ ] Tests unitarios solo para `core/`
  - [ ] Mocks para todas las interfaces
  - [ ] Integration tests para adapters

---

## 5. ğŸ“‹ Contratos y ValidaciÃ³n (Spec-Driven Development)

### DescripciÃ³n
Todo desarrollo debe partir de especificaciones formales usando OpenAPI y JSON Schema, con validaciÃ³n automÃ¡tica.

### Flujo SDD Obligatorio
1. **Specs primero** â†’ OpenAPI + JSON Schema
2. **Tests despuÃ©s** â†’ Contract tests que fallan
3. **ImplementaciÃ³n final** â†’ Hacer tests verdes

### Estructura de Contratos
```
/openapi/                   # Endpoints propios
â”œâ”€â”€ pulsedesk-api.yaml     # API principal
â””â”€â”€ webhooks.yaml          # Webhooks externos

/schemas/capabilities/      # Tools y capabilities
â”œâ”€â”€ ticket-tool.schema.json
â”œâ”€â”€ kb-search.schema.json
â””â”€â”€ notification.schema.json
```

### Checklist TÃ©cnico
- [ ] **Especificaciones**
  - [ ] OpenAPI specs en `/openapi/`
  - [ ] JSON Schemas en `/schemas/capabilities/`
  - [ ] Ejemplos vÃ¡lidos e invÃ¡lidos
- [ ] **Contract Testing**
  - [ ] Tests que validan OpenAPI compliance
  - [ ] JSON Schema validation con AJV
  - [ ] Tests que fallan pre-implementaciÃ³n
- [ ] **Tooling**
  - [ ] Spectral para linting OpenAPI
  - [ ] Automated contract validation en CI
  - [ ] Schema-driven mock generation

---

## 6. ğŸ”§ EstandarizaciÃ³n del CÃ³digo

### DescripciÃ³n
Garantizar calidad de cÃ³digo mediante reglas estrictas y herramientas automÃ¡ticas.

### ConfiguraciÃ³n Obligatoria
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "noImplicitReturns": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

### Standards Aplicados
- ğŸ“ **TypeScript**: Strict mode sin excepciones
- ğŸ¨ **Formatting**: ESLint + Prettier automÃ¡tico
- ğŸ§ª **Coverage**: â‰¥90% core/, â‰¥80% adapters/
- ğŸš« **Error Handling**: Result/Either patterns

### Checklist TÃ©cnico
- [ ] **TypeScript Strict**
  - [ ] `strict: true` configurado
  - [ ] Boundary enforcement rules
  - [ ] Explicit return types en functions pÃºblicas
- [ ] **Linting & Formatting**
  - [ ] ESLint config sin warnings
  - [ ] Prettier automÃ¡tico en pre-commit
  - [ ] Import ordering rules
- [ ] **Error Management**
  - [ ] Centralized errors en `core/errors/`
  - [ ] Result types para operations
  - [ ] No throw exceptions en business logic
- [ ] **Configuration**
  - [ ] Zod validation para env vars
  - [ ] Fail-fast si config invÃ¡lida
  - [ ] Typed config derivado de schemas

---

## 7. ğŸ“Š Observabilidad

### DescripciÃ³n
Implementar logging estructurado, mÃ©tricas bÃ¡sicas y correlation tracking para debugging y monitoring.

### Componentes de Observabilidad
- ğŸ“ **Structured Logging**: Pino con JSON format
- ğŸ”— **Correlation IDs**: Request tracking
- ğŸ“ˆ **Basic Metrics**: Latency, success/error rates
- ğŸ” **Optional Tracing**: OpenTelemetry para crÃ­ticos

### Logging Strategy
```typescript
// Structured logging example
logger.info({
  correlationId: req.correlationId,
  operation: 'ticket.create',
  userId: req.user.id,
  duration: Date.now() - startTime,
  success: true
}, 'Ticket created successfully');
```

### Checklist TÃ©cnico
- [ ] **Structured Logging**
  - [ ] Pino configurado con JSON output
  - [ ] Correlation IDs en TODAS las operations
  - [ ] Log levels apropiados (ERROR, WARN, INFO, DEBUG)
  - [ ] No PII en logs
- [ ] **Metrics Collection**
  - [ ] Response time tracking
  - [ ] Success/error rate counters  
  - [ ] Retry attempt logging
  - [ ] External API latency
- [ ] **Testing Observability**
  - [ ] Tests que validen correlation ID propagation
  - [ ] Log assertion en integration tests
  - [ ] Metrics validation en tests

---

## 8. ğŸš€ CI/CD y Calidad

### DescripciÃ³n
Automatizar validaciÃ³n de calidad en cada PR con gates estrictos y feedback rÃ¡pido.

### Pipeline Obligatorio
```yaml
# CI Pipeline stages
stages:
  - lint          # ESLint + Prettier
  - typecheck     # tsc --noEmit  
  - test:unit     # Jest unit tests
  - test:integration # Integration tests
  - test:contract    # OpenAPI/Schema validation
  - audit         # npm audit + OSV
```

### Quality Gates
- ğŸš¦ **Coverage**: â‰¥90% core/, â‰¥80% adapters/
- ğŸ”’ **Branch Protection**: PR reviews required
- âœ… **All Green**: No merge con tests fallando
- ğŸ“ **Size Limit**: <300 LOC netas por PR

### Checklist TÃ©cnico
- [ ] **CI Configuration**
  - [ ] All pipeline stages configured
  - [ ] Coverage reporting automÃ¡tico
  - [ ] Failure notifications
- [ ] **Quality Gates**
  - [ ] Branch protection rules active
  - [ ] Required reviewers configured
  - [ ] Auto-merge bloqueado si CI fails
- [ ] **Tooling Integration**
  - [ ] Spectral para OpenAPI linting
  - [ ] Dependency vulnerability scanning
  - [ ] Performance regression detection

---

## 9. ğŸ” Seguridad

### DescripciÃ³n
Asegurar que el cÃ³digo y las integraciones cumplen con principios bÃ¡sicos de seguridad y privacidad.

### Principios de Seguridad
- ğŸ”‘ **Secrets Management**: Solo env vars/secret stores
- ğŸ¯ **Least Privilege**: Scopes mÃ­nimos en tokens
- ğŸ™ˆ **PII Redaction**: No datos sensibles en logs
- ğŸ”„ **Key Rotation**: Periodic credential refresh

### Security Checklist
- [ ] **Secrets Handling**
  - [ ] No hardcoded secrets en cÃ³digo
  - [ ] Environment variables validation
  - [ ] Secret rotation procedures documented
- [ ] **Access Control**
  - [ ] Minimum scopes para Slack/Jira tokens
  - [ ] API rate limiting implemented
  - [ ] Input validation en all endpoints
- [ ] **Data Protection**
  - [ ] PII redaction en logging
  - [ ] Data encryption at rest (si aplica)
  - [ ] Secure communication (HTTPS/TLS)
- [ ] **Testing Security**
  - [ ] Secret leak detection tests
  - [ ] Input validation tests
  - [ ] Authorization tests

---

## 10. âœ… Definition of Done (DoD)

### DescripciÃ³n
Criterios claros y no negociables para considerar completo cualquier trabajo de desarrollo.

### DoD para PR de Especificaciones
- [ ] **OpenAPI** actualizado y vÃ¡lido
- [ ] **JSON Schemas** con ejemplos vÃ¡lidos/invÃ¡lidos
- [ ] **Contract tests** implementados y verdes
- [ ] **DocumentaciÃ³n** mÃ­nima del cambio

### DoD para PR de ImplementaciÃ³n  
- [ ] **CI Pipeline** completamente verde
  - [ ] TypeScript typecheck pasa
  - [ ] ESLint sin warnings
  - [ ] Tests unitarios + integraciÃ³n pasan
  - [ ] Coverage â‰¥ thresholds definidos
- [ ] **Architecture Compliance**
  - [ ] Respeta arquitectura hexagonal
  - [ ] Core sin dependencias externas
  - [ ] Interfaces implementadas correctamente
- [ ] **Code Quality**
  - [ ] Logs estructurados con correlation IDs
  - [ ] Error handling con Result types
  - [ ] No secrets en plain text
  - [ ] Configuration validada con Zod
- [ ] **Documentation**
  - [ ] TODOs tienen issues asociados
  - [ ] ADRs actualizados si aplica
  - [ ] README updated si hay cambios de setup

### Validation Checklist
- [ ] **Functional**: Feature works como especificado
- [ ] **Technical**: Cumple standards de calidad
- [ ] **Security**: No vulnerabilities introducidas
- [ ] **Performance**: Responde en <2s para Slack
- [ ] **Maintainability**: CÃ³digo es legible y testeable

---

## ğŸ“ Notas de ImplementaciÃ³n

### PriorizaciÃ³n Sugerida
1. **P0**: Architecture setup + Core interfaces
2. **P1**: Basic Slack â†” Mastra integration  
3. **P2**: Persistence + Context management
4. **P3**: Capabilities (Tickets, KB, Notifications)
5. **P4**: Proactivity + Advanced features

### Tracking Progress
- Usar este documento como checklist durante development
- Crear issues especÃ­ficos para cada specification
- Link PRs a specifications correspondientes
- Update este documento conforme evoluciona el MVP

---

**ğŸ“„ Documento vivo**: Este archivo debe actualizarse conforme evoluciona el proyecto, manteniendo siempre la alineaciÃ³n con la constituciÃ³n del proyecto.